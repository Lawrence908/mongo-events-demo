{% extends "base.html" %}

{% block title %}Events Map - MongoDB Events Demo{% endblock %}

{% block content %}
<div x-data="eventsMap()">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Events Map</h1>
            
            <!-- Map Controls -->
            <div class="card mb-4 map-controls">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Search Radius (km)</label>
                            <input type="number" class="form-control" x-model="radius" min="1" max="100" step="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Results</label>
                            <input type="number" class="form-control" x-model="maxResults" min="1" max="100" step="1">
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" x-model="useCurrentLocation" id="useLocation">
                                <label class="form-check-label" for="useLocation">
                                    Use Current Location
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-accent w-100" @click="searchEvents()">
                                <span x-show="!loading">Search Events</span>
                                <span x-show="loading" class="spinner-border spinner-border-sm me-2"></span>
                                <span x-show="loading">Loading...</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Category Filters -->
                    <div class="mt-3">
                        <h6 class="mb-2">Event Categories</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <template x-for="category in allCategories" :key="category">
                                <button type="button"
                                        class="btn btn-sm"
                                        :class="selectedCategories.includes(category) ? 'btn-accent' : 'btn-outline-accent'"
                                        @click="toggleCategory(category)">
                                    <span class="me-1" x-text="getCategoryEmoji(category)"></span>
                                    <span x-text="category"></span>
                                </button>
                            </template>
                            <button type="button" class="btn btn-sm btn-outline-accent" @click="clearCategories()">
                                <i class="bi bi-x-circle me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="mt-4" x-show="filteredEvents().length > 0">
                <h3>Found Events (<span x-text="filteredEvents().length"></span>)</h3>
                <div class="row">
                    <template x-for="event in filteredEvents()" :key="event.properties.id">
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card event-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0" x-text="event.properties.title"></h5>
                                        <span class="badge category-badge" :style="`background-color: ${getCategoryColor(event.properties.category)}`" x-text="event.properties.category"></span>
                                    </div>
                                    <p class="card-text text-muted small" x-text="event.properties.description"></p>
                                    <div class="small text-muted">
                                        <div><strong>Date:</strong> <span x-text="formatDate(event.properties.startDate)"></span></div>
                                        <div x-show="event.properties.organizer"><strong>Organizer:</strong> <span x-text="event.properties.organizer"></span></div>
                                        <div><strong>Distance:</strong> <span x-text="event.properties.distance"></span>m</div>
                                    </div>
                                    <div class="mt-2">
                                        <a :href="`/events/${event.properties.id}`" class="btn btn-sm btn-outline-accent">View Details</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- No Results Message -->
            <div class="alert alert-info mt-4" x-show="searched && events.length === 0">
                No events found in this area. Try increasing the search radius or searching a different location.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function eventsMap() {
    return {
        map: null,
        markersLayer: null,
        searchCircle: null,
        events: [],
        allCategories: ['Technology','Music','Sports','Food & Drink','Arts & Culture','Business','Education','Health & Wellness'],
        selectedCategories: [],
        loading: false,
        searched: false,
        radius: 10,
        maxResults: 50,
        useCurrentLocation: false,
        currentLat: 40.7128,
        currentLng: -74.0060, // Default to NYC
        
        init() {
            this.initMap();
            this.getCurrentLocation();
        },
        
        initMap() {
            this.map = L.map('map').setView([this.currentLat, this.currentLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(this.map);
            
            this.markersLayer = L.layerGroup().addTo(this.map);
            
            // Add click event to map
            this.map.on('click', (e) => {
                if (!this.useCurrentLocation) {
                    this.currentLat = e.latlng.lat;
                    this.currentLng = e.latlng.lng;
                    this.showSearchArea();
                }
            });
        },
        
        getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    this.currentLat = position.coords.latitude;
                    this.currentLng = position.coords.longitude;
                    this.map.setView([this.currentLat, this.currentLng], 13);
                    if (this.useCurrentLocation) {
                        this.showSearchArea();
                    }
                });
            }
        },
        
        showSearchArea() {
            if (this.searchCircle) {
                this.map.removeLayer(this.searchCircle);
            }
            
            this.searchCircle = L.circle([this.currentLat, this.currentLng], {
                radius: this.radius * 1000, // Convert to meters
                fillColor: '#00ED64',
                fillOpacity: 0.1,
                color: '#00ED64',
                weight: 2,
                opacity: 0.8
            }).addTo(this.map);
        },
        
        async searchEvents() {
            this.loading = true;
            this.searched = true;
            
            if (this.useCurrentLocation) {
                this.getCurrentLocation();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for location
            }
            
            this.showSearchArea();
            
            try {
                const response = await fetch(`/api/events/nearby?lat=${this.currentLat}&lng=${this.currentLng}&radius=${this.radius}&limit=${this.maxResults}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.events = data.features || [];
                    this.displayEventMarkers();
                } else {
                    console.error('Error fetching events:', data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
            }
            
            this.loading = false;
        },
        
        displayEventMarkers() {
            this.markersLayer.clearLayers();
            
            this.filteredEvents().forEach(event => {
                const [lng, lat] = event.geometry.coordinates;
                
                // Create custom icon based on category
                const categoryIcon = this.getCategoryIcon(event.properties.category);
                const marker = L.marker([lat, lng], { icon: categoryIcon }).bindPopup(`
                    <div class="popup-content">
                        <h6>${event.properties.title}</h6>
                        <p class="small mb-2">${event.properties.description || ''}</p>
                        <div class="small text-muted">
                            <div><strong>Category:</strong> <span class="badge" style="background-color: ${this.getCategoryColor(event.properties.category)}">${event.properties.category}</span></div>
                            <div><strong>Date:</strong> ${this.formatDate(event.properties.startDate)}</div>
                            ${event.properties.organizer ? `<div><strong>Organizer:</strong> ${event.properties.organizer}</div>` : ''}
                            <div><strong>Distance:</strong> ${event.properties.distance}m</div>
                        </div>
                        <div class="mt-2">
                            <a href="/events/${event.properties.id}" class="btn btn-sm btn-accent">View Details</a>
                        </div>
                    </div>
                `);
                
                this.markersLayer.addLayer(marker);
            });
            
            if (this.events.length > 0) {
                const group = new L.featureGroup(this.markersLayer.getLayers());
                this.map.fitBounds(group.getBounds().pad(0.1));
            }
        },
        
        filteredEvents() {
            if (this.selectedCategories.length === 0) {
                return this.events;
            }
            return this.events.filter(e => this.selectedCategories.includes(e.properties.category));
        },
        
        toggleCategory(category) {
            if (this.selectedCategories.includes(category)) {
                this.selectedCategories = this.selectedCategories.filter(c => c !== category);
            } else {
                this.selectedCategories = [...this.selectedCategories, category];
            }
            this.displayEventMarkers();
        },
        
        clearCategories() {
            this.selectedCategories = [];
            this.displayEventMarkers();
        },
        
        getCategoryIcon(category) {
            // Define category-specific icons and colors
            const categoryConfig = {
                'Technology': { icon: 'üíª', color: '#0d6efd' },
                'Music': { icon: 'üéµ', color: '#e83e8c' },
                'Sports': { icon: '‚öΩ', color: '#28a745' },
                'Food & Drink': { icon: 'üçï', color: '#fd7e14' },
                'Arts & Culture': { icon: 'üé®', color: '#6f42c1' },
                'Business': { icon: 'üíº', color: '#6c757d' },
                'Education': { icon: 'üìö', color: '#17a2b8' },
                'Health & Wellness': { icon: 'üí™', color: '#20c997' },
                'Entertainment': { icon: 'üé≠', color: '#ffc107' },
                'Community': { icon: 'ü§ù', color: '#dc3545' },
                'Science': { icon: 'üî¨', color: '#6f42c1' },
                'Fashion': { icon: 'üëó', color: '#e83e8c' },
                'Travel': { icon: '‚úàÔ∏è', color: '#17a2b8' },
                'Photography': { icon: 'üì∏', color: '#6c757d' },
                'Gaming': { icon: 'üéÆ', color: '#28a745' },
                'Networking': { icon: 'ü§ù', color: '#fd7e14' }
            };
            
            const config = categoryConfig[category] || { icon: 'üìç', color: '#6c757d' };
            
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${config.color};
                    color: white;
                    border: 2px solid white;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                ">${config.icon}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        },
        
        getCategoryColor(category) {
            const categoryConfig = {
                'Technology': '#007bff',
                'Music': '#e83e8c',
                'Sports': '#28a745',
                'Food & Drink': '#fd7e14',
                'Arts & Culture': '#6f42c1',
                'Business': '#6c757d',
                'Education': '#17a2b8',
                'Health & Wellness': '#20c997',
                'Entertainment': '#ffc107',
                'Community': '#dc3545',
                'Science': '#6f42c1',
                'Fashion': '#e83e8c',
                'Travel': '#17a2b8',
                'Photography': '#6c757d',
                'Gaming': '#28a745',
                'Networking': '#fd7e14'
            };
            return categoryConfig[category] || '#6c757d';
        },
        
        getCategoryEmoji(category) {
            const map = {
                'Technology': 'üíª',
                'Music': 'üéµ',
                'Sports': '‚öΩ',
                'Food & Drink': 'üçï',
                'Arts & Culture': 'üé®',
                'Business': 'üíº',
                'Education': 'üìö',
                'Health & Wellness': 'üí™'
            };
            return map[category] || 'üìç';
        },
        
        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }
}
</script>
{% endblock %}